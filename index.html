<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>My Crypto Portfolio</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; padding: 20px; background-color: #f0f2f5; color: #333; }
  .container { max-width: 950px; margin: auto; background: white; padding: 25px; border-radius: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
  
  .header-area { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; margin-bottom: 20px; }
  h1 { margin: 0; color: #1a1a1a; font-size: 28px; }
  .currency-selector { padding: 8px 12px; border-radius: 6px; border: 1px solid #ccd0d5; font-size: 16px; font-weight: bold; background-color: #f8f9fa; cursor: pointer; }

  .form-group { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; align-items: flex-start; }
  input { padding: 10px; border: 1px solid #ccd0d5; border-radius: 6px; font-size: 14px; width: 100%; box-sizing: border-box; }
  
  /* Autocomplete Styles */
  .autocomplete-wrapper { position: relative; flex: 1; min-width: 180px; }
  .autocomplete-items { position: absolute; border: 1px solid #d4d4d4; border-bottom: none; border-top: none; z-index: 99; top: 100%; left: 0; right: 0; background: white; max-height: 250px; overflow-y: auto; border-radius: 0 0 6px 6px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
  .autocomplete-items div { padding: 10px; cursor: pointer; border-bottom: 1px solid #d4d4d4; font-size: 14px; display: flex; align-items: center; }
  .autocomplete-items div:hover { background-color: #f0f2f5; }
  .autocomplete-items img { width: 20px; height: 20px; margin-right: 10px; border-radius: 50%; }

  .date-wrapper, .amount-wrapper, .paid-wrapper { flex: 1; min-width: 130px; }
  button { padding: 10px 20px; background-color: #0064e6; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; transition: 0.2s; height: 40px; margin-top: 0px; }
  button:hover { background-color: #004baf; }
  
  .action-buttons { display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap; }
  .btn-refresh { background-color: #28a745; }
  .btn-refresh:hover { background-color: #1e7e34; }
  .btn-export { background-color: #6c757d; }
  .btn-export:hover { background-color: #5a6268; }
  .btn-import { background-color: #17a2b8; }
  .btn-import:hover { background-color: #117a8b; }

  .chart-container { max-width: 350px; margin: 30px auto; }

  table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 14px; }
  th, td { padding: 12px; text-align: left; border-bottom: 1px solid #eaedf0; }
  th { background-color: #f8f9fa; font-weight: 600; }
  .profit { color: #28a745; font-weight: bold; }
  .loss { color: #dc3545; font-weight: bold; }
  .date-col { color: #6c757d; font-size: 13px; }
  
  .summary-box { margin-top: 30px; padding: 20px; background-color: #f8f9fa; border-radius: 8px; border: 1px solid #eaedf0; font-size: 22px; display: flex; justify-content: space-between; flex-wrap: wrap; gap: 15px; }
  .summary-box div { flex: 1; min-width: 200px; text-align: center; }
  .summary-box strong { display: block; font-size: 13px; color: #6c757d; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px; }
  .summary-value { font-weight: bold; color: #1a1a1a; }
</style>
</head>
<body>

<div class="container">
  <div class="header-area">
    <h1>ðŸ“ˆ Crypto Portfolio</h1>
    <select id="currency" class="currency-selector" onchange="changeCurrency()">
      <option value="usd">ðŸ‡ºðŸ‡¸ USD ($)</option>
      <option value="eur">ðŸ‡ªðŸ‡º EUR (â‚¬)</option>
      <option value="gbp">ðŸ‡¬ðŸ‡§ GBP (Â£)</option>
      <option value="aud">ðŸ‡¦ðŸ‡º AUD (A$)</option>
      <option value="cad">ðŸ‡¨ðŸ‡¦ CAD (C$)</option>
      <option value="inr">ðŸ‡®ðŸ‡³ INR (â‚¹)</option>
      <option value="aed">ðŸ‡¦ðŸ‡ª AED (Ø¯.Ø¥)</option>
      <option value="jpy">ðŸ‡¯ðŸ‡µ JPY (Â¥)</option>
      <option value="cny">ðŸ‡¨ðŸ‡³ CNY (Â¥)</option>
      <option value="chf">ðŸ‡¨ðŸ‡­ CHF (CHF)</option>
      <option value="sgd">ðŸ‡¸ðŸ‡¬ SGD (S$)</option>
      <option value="hkd">ðŸ‡­ðŸ‡° HKD (HK$)</option>
    </select>
  </div>
  
  <div class="form-group">
    <div class="autocomplete-wrapper">
      <input type="text" id="coinSearch" placeholder="Search coin (e.g. BTC)" autocomplete="off" oninput="handleSearchInput()">
      <input type="hidden" id="selectedCoinId">
      <div id="autocomplete-list" class="autocomplete-items"></div>
    </div>

    <div class="date-wrapper">
      <input type="date" id="purchaseDate" required>
    </div>
    <div class="amount-wrapper">
      <input type="number" id="amount" placeholder="Amount (e.g. 0.5)" step="any" required>
    </div>
    <div class="paid-wrapper">
      <input type="number" id="totalPaid" placeholder="Total Paid" step="any" required>
    </div>
    <button onclick="addTransaction()">Add Trade</button>
  </div>
  
  <div class="action-buttons">
    <button class="btn-refresh" onclick="refreshPrices()">ðŸ”„ Refresh Live Prices</button>
    <button class="btn-export" onclick="exportToCSV()">ðŸ’¾ Export to CSV</button>
    <input type="file" id="csvFileInput" accept=".csv" style="display: none;" onchange="importFromCSV(event)">
    <button class="btn-import" onclick="document.getElementById('csvFileInput').click()">ðŸ“‚ Import CSV</button>
  </div>

  <div class="chart-container">
    <canvas id="portfolioChart"></canvas>
  </div>

  <table>
    <thead>
      <tr>
        <th>Asset</th>
        <th>Date</th>
        <th>Holdings</th>
        <th>Avg Buy Price</th>
        <th>Current Price</th>
        <th>Current Value</th>
        <th>Profit / Loss</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody id="portfolioBody">
      </tbody>
  </table>
  
  <div class="summary-box">
    <div>
      <strong>Total Invested</strong>
      <div class="summary-value" id="totalInvested">0.00</div>
    </div>
    <div>
      <strong>Current Value</strong>
      <div class="summary-value" id="totalValue">0.00</div>
    </div>
    <div>
      <strong>Total Profit / Loss</strong>
      <div id="totalPnL" class="summary-value">0.00 (0.00%)</div>
    </div>
  </div>
</div>

<script>
  let portfolio = JSON.parse(localStorage.getItem('cryptoPortfolio')) || {};
  let currentCurrency = localStorage.getItem('portfolioCurrency') || 'usd';
  let myPieChart = null; 
  let searchTimeout = null;

  document.getElementById('purchaseDate').valueAsDate = new Date();
  document.getElementById('currency').value = currentCurrency;

  function savePortfolio() {
    localStorage.setItem('cryptoPortfolio', JSON.stringify(portfolio));
    localStorage.setItem('portfolioCurrency', currentCurrency);
  }

  function formatMoney(value) {
    return new Intl.NumberFormat('en-US', {
      style: 'currency',
      currency: currentCurrency.toUpperCase(),
      minimumFractionDigits: 2,
      maximumFractionDigits: currentCurrency === 'jpy' ? 0 : 4
    }).format(value);
  }

  function changeCurrency() {
    currentCurrency = document.getElementById('currency').value;
    savePortfolio();
    refreshPrices(); 
  }

  // --- NEW: Live Search Auto-Suggest Functions ---
  async function handleSearchInput() {
    const query = document.getElementById('coinSearch').value.trim();
    const list = document.getElementById('autocomplete-list');
    
    // Clear the hidden ID if the user starts typing again
    document.getElementById('selectedCoinId').value = '';
    list.innerHTML = '';

    if (query.length < 2) return; // Wait until they type at least 2 letters

    // Debounce: Wait 400ms after they stop typing to call the API
    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(async () => {
      try {
        const response = await fetch(`https://api.coingecko.com/api/v3/search?query=${query}`);
        const data = await response.json();
        
        // Show up to 6 results
        const coins = data.coins.slice(0, 6);
        
        if (coins.length === 0) {
          list.innerHTML = `<div style="color: #dc3545;">No coins found.</div>`;
          return;
        }

        coins.forEach(coin => {
          const div = document.createElement('div');
          div.innerHTML = `<img src="${coin.thumb}" alt="logo"> <strong>${coin.name}</strong> &nbsp;(<span style="text-transform:uppercase;">${coin.symbol}</span>)`;
          
          // When a user clicks a suggestion
          div.onclick = function() {
            document.getElementById('coinSearch').value = coin.name; // Show nice name
            document.getElementById('selectedCoinId').value = coin.id; // Save strict API ID
            list.innerHTML = ''; // Hide dropdown
          };
          list.appendChild(div);
        });
      } catch (error) {
        console.error("Search error:", error);
      }
    }, 400); 
  }

  // Close the dropdown if the user clicks anywhere else on the page
  document.addEventListener("click", function (e) {
    if (e.target.id !== "coinSearch") {
      document.getElementById("autocomplete-list").innerHTML = "";
    }
  });


  function addTransaction() {
    // We now use the hidden ID, NOT the text input
    const coinId = document.getElementById('selectedCoinId').value; 
    const purchaseDate = document.getElementById('purchaseDate').value;
    const amount = parseFloat(document.getElementById('amount').value);
    const totalPaid = parseFloat(document.getElementById('totalPaid').value);

    // Strict check: Prevent manual typing
    if (!coinId) {
      alert("âŒ Please search for a coin and select it from the dropdown list.");
      return;
    }

    if (!purchaseDate || isNaN(amount) || isNaN(totalPaid)) {
      alert("Please fill out all number fields correctly.");
      return;
    }

    if (!portfolio[coinId]) {
      portfolio[coinId] = { amount: 0, totalPaid: 0, currentPrice: 0, date: purchaseDate };
    } else if (portfolio[coinId].date !== purchaseDate) {
      portfolio[coinId].date = 'Multiple';
    }

    portfolio[coinId].amount += amount;
    portfolio[coinId].totalPaid += totalPaid;
    
    // Clear inputs
    document.getElementById('coinSearch').value = '';
    document.getElementById('selectedCoinId').value = '';
    document.getElementById('amount').value = '';
    document.getElementById('totalPaid').value = '';

    savePortfolio();
    refreshPrices(); 
  }

  function removeCoin(coinId) {
    if(confirm(`Are you sure you want to remove ${coinId}?`)) {
      delete portfolio[coinId];
      savePortfolio();
      renderPortfolio();
    }
  }

  async function refreshPrices() {
    const coins = Object.keys(portfolio);
    if (coins.length === 0) {
      renderPortfolio();
      return;
    }

    try {
      const response = await fetch(`https://api.coingecko.com/api/v3/simple/price?ids=${coins.join(',')}&vs_currencies=${currentCurrency}`);
      const data = await response.json();

      for (const coin of coins) {
        if (data[coin] && data[coin][currentCurrency]) {
          portfolio[coin].currentPrice = data[coin][currentCurrency];
        }
      }
      savePortfolio();
      renderPortfolio();
    } catch (error) {
      console.error("Error fetching prices:", error);
    }
  }

  function renderPortfolio() {
    const tbody = document.getElementById('portfolioBody');
    tbody.innerHTML = '';
    
    let totalPortfolioValue = 0;
    let totalInvestedAmount = 0;
    
    let chartLabels = [];
    let chartData = [];
    let chartColors = ['#0064e6', '#28a745', '#ffc107', '#dc3545', '#17a2b8', '#6610f2', '#fd7e14', '#e83e8c', '#20c997'];

    for (const [coinId, data] of Object.entries(portfolio)) {
      const avgPrice = data.totalPaid / data.amount;
      const currentValue = data.amount * data.currentPrice;
      const profitLoss = currentValue - data.totalPaid;
      const plClass = profitLoss >= 0 ? 'profit' : 'loss';
      const plSign = profitLoss >= 0 ? '+' : '';
      const displayDate = data.date || 'N/A';
      
      totalPortfolioValue += currentValue;
      totalInvestedAmount += data.totalPaid;

      chartLabels.push(coinId.toUpperCase());
      chartData.push(currentValue);

      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td style="text-transform: capitalize; font-weight: bold;">${coinId}</td>
        <td class="date-col">${displayDate}</td>
        <td>${data.amount.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 6})}</td>
        <td>${formatMoney(avgPrice)}</td>
        <td>${formatMoney(data.currentPrice)}</td>
        <td>${formatMoney(currentValue)}</td>
        <td class="${plClass}">${plSign}${formatMoney(Math.abs(profitLoss))}</td>
        <td><button onclick="removeCoin('${coinId}')" style="background-color: #dc3545; padding: 6px 12px; font-size: 12px;">Remove</button></td>
      `;
      tbody.appendChild(tr);
    }

    const totalPnL = totalPortfolioValue - totalInvestedAmount;
    const totalPnLPercent = totalInvestedAmount > 0 ? (totalPnL / totalInvestedAmount) * 100 : 0;
    
    const summaryPlClass = totalPnL >= 0 ? 'profit summary-value' : 'loss summary-value';
    const summaryPlSign = totalPnL >= 0 ? '+' : '';

    document.getElementById('totalInvested').innerText = formatMoney(totalInvestedAmount);
    document.getElementById('totalValue').innerText = formatMoney(totalPortfolioValue);
    
    const pnlElement = document.getElementById('totalPnL');
    pnlElement.className = summaryPlClass;
    pnlElement.innerText = `${summaryPlSign}${formatMoney(Math.abs(totalPnL))} (${summaryPlSign}${Math.abs(totalPnLPercent).toFixed(2)}%)`;

    updateChart(chartLabels, chartData, chartColors);
  }

  function updateChart(labels, data, colors) {
    const ctx = document.getElementById('portfolioChart').getContext('2d');
    if (myPieChart) myPieChart.destroy();
    if (data.length === 0) return;

    myPieChart = new Chart(ctx, {
      type: 'doughnut',
      data: {
        labels: labels,
        datasets: [{ data: data, backgroundColor: colors, borderWidth: 2, hoverOffset: 4 }]
      },
      options: {
        responsive: true,
        plugins: {
          legend: { position: 'bottom' },
          tooltip: {
            callbacks: {
              label: function(context) {
                let label = context.label || '';
                if (label) label += ': ';
                if (context.parsed !== null) label += formatMoney(context.parsed);
                return label;
              }
            }
          }
        }
      }
    });
  }

  function exportToCSV() {
    if (Object.keys(portfolio).length === 0) return;

    const currCode = currentCurrency.toUpperCase();
    let csvContent = `Asset,Date,Holdings,Avg Buy Price (${currCode}),Current Price (${currCode}),Current Value (${currCode}),Profit/Loss (${currCode})\n`;

    for (const [coinId, data] of Object.entries(portfolio)) {
      const avgPrice = (data.totalPaid / data.amount).toFixed(4);
      const currentValue = (data.amount * data.currentPrice).toFixed(4);
      const profitLoss = (currentValue - data.totalPaid).toFixed(4);
      const dateStr = data.date || 'N/A';
      
      const row = `${coinId},${dateStr},${data.amount},${avgPrice},${data.currentPrice},${currentValue},${profitLoss}`;
      csvContent += row + "\n";
    }

    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement("a");
    const url = URL.createObjectURL(blob);
    link.setAttribute("href", url);
    link.setAttribute("download", `crypto_portfolio_${currCode}.csv`);
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  }

  function importFromCSV(event) {
    const file = event.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = function(e) {
      const text = e.target.result;
      const lines = text.split('\n');
      const hasDateColumn = lines[0].toLowerCase().includes('date');
      
      let newPortfolio = {};
      let importedCount = 0;

      for (let i = 1; i < lines.length; i++) {
        const line = lines[i].trim();
        if (!line) continue;

        const columns = line.split(',');
        const dateIndex = hasDateColumn ? 1 : -1;
        const amountIndex = hasDateColumn ? 2 : 1;
        const avgPriceIndex = hasDateColumn ? 3 : 2;

        if (columns.length >= (hasDateColumn ? 4 : 3)) {
          const coinId = columns[0].trim();
          const amount = parseFloat(columns[amountIndex]);
          const avgPrice = parseFloat(columns[avgPriceIndex]);
          const date = hasDateColumn ? columns[dateIndex].trim() : 'Imported';

          if (coinId && !isNaN(amount) && !isNaN(avgPrice)) {
            const totalPaid = amount * avgPrice;
            newPortfolio[coinId] = { amount: amount, totalPaid: totalPaid, currentPrice: 0, date: date };
            importedCount++;
          }
        }
      }

      if (importedCount > 0) {
        if (Object.keys(portfolio).length > 0) {
          if (!confirm("This will overwrite your existing portfolio. Continue?")) {
             event.target.value = ''; return; 
          }
        }
        portfolio = newPortfolio;
        savePortfolio();
        refreshPrices();
      } else {
        alert("Could not read valid data.");
      }
      event.target.value = ''; 
    };
    reader.readAsText(file);
  }

  refreshPrices();
</script>
</body>
</html>
