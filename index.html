<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crypto Portfolio Pro</title>
    <style>
        :root { --primary: #0064e6; --success: #28a745; --danger: #dc3545; --bg: #f4f7f9; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: var(--bg); margin: 0; padding: 20px; color: #333; }
        .container { max-width: 1200px; margin: auto; background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); }
        
        h1 { margin-top: 0; color: #1a1a1a; display: flex; align-items: center; gap: 10px; font-size: 24px; }
        .refresh-status { font-size: 12px; font-weight: normal; color: #666; margin-left: auto; }

        /* Input Form */
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 12px; margin-bottom: 20px; padding: 20px; background: #fafafa; border-radius: 10px; border: 1px solid #eee; }
        input { padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px; outline: none; transition: border 0.2s; }
        input:focus { border-color: var(--primary); }
        .btn-add { background: var(--primary); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; }
        .btn-add:hover { background: #0052be; }

        /* Search Bar */
        .search-container { margin-bottom: 20px; }
        .search-input { width: 100%; padding: 15px; border: 2px solid #eee; border-radius: 10px; box-sizing: border-box; font-size: 15px; outline: none; }
        .search-input:focus { border-color: var(--primary); }

        /* Table Styling */
        .table-wrapper { width: 100%; overflow-x: auto; border-radius: 10px; border: 1px solid #eee; margin-bottom: 25px; }
        table { width: 100%; border-collapse: collapse; min-width: 1000px; }
        
        /* Sortable Headers */
        th { background: #f8f9fa; text-align: left; padding: 15px; font-size: 11px; text-transform: uppercase; color: #777; cursor: pointer; user-select: none; position: relative; border-bottom: 2px solid #eee; }
        th:hover { background: #f0f4f8; color: var(--primary); }
        th::after { content: ' â†•'; opacity: 0.3; margin-left: 5px; font-size: 10px; }
        
        td { padding: 15px; border-bottom: 1px solid #f0f0f0; font-size: 14px; }
        tr:last-child td { border-bottom: none; }
        
        .asset-name { text-transform: capitalize; font-weight: bold; color: #1a1a1a; }
        .profit { color: var(--success); font-weight: bold; }
        .loss { color: var(--danger); font-weight: bold; }

        /* Summary Dashboard */
        .summary-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-top: 10px; }
        .card { padding: 20px; background: #f8f9fa; border-radius: 10px; text-align: center; border: 1px solid #eee; }
        .card span { display: block; font-size: 12px; color: #666; text-transform: uppercase; margin-bottom: 8px; letter-spacing: 0.5px; }
        .card strong { font-size: 22px; color: #1a1a1a; }

        .btn-delete { background: none; border: none; color: #ccc; cursor: pointer; font-size: 18px; transition: 0.2s; }
        .btn-delete:hover { color: var(--danger); }

        footer { margin-top: 30px; text-align: center; font-size: 13px; color: #999; }
        footer a { color: var(--primary); text-decoration: none; }

        @media (max-width: 600px) { .form-grid { grid-template-columns: 1fr; } .container { padding: 15px; } }
    </style>
</head>
<body>

<div class="container">
    <h1>
        ðŸ“ˆ Crypto Portfolio 
        <span class="refresh-status" id="lastUpdated">Updating prices...</span>
    </h1>

    <div class="form-grid">
        <input type="text" id="coinId" placeholder="Coin ID (e.g. bitcoin)">
        <input type="date" id="tradeDate">
        <input type="number" id="holdings" placeholder="Amount of Coins" step="any">
        <input type="number" id="buyPrice" placeholder="Buy Price (1 Unit)" step="any">
        <button class="btn-add" onclick="addTrade()">Add Trade</button>
    </div>

    <div class="search-container">
        <input type="text" id="searchInput" class="search-input" placeholder="ðŸ” Search by asset, date, or amount..." onkeyup="filterTable()">
    </div>

    <div class="table-wrapper">
        <table id="portfolioTable">
            <thead>
                <tr>
                    <th onclick="sortTable(0)">Asset</th>
                    <th onclick="sortTable(1)">Current Price</th>
                    <th onclick="sortTable(2)">Date</th>
                    <th onclick="sortTable(3)">Holdings</th>
                    <th onclick="sortTable(4)">Buy Price (Unit)</th>
                    <th onclick="sortTable(5)">Invested</th>
                    <th onclick="sortTable(6)">Current Value</th>
                    <th onclick="sortTable(7)">Profit/Loss</th>
                    <th style="cursor:default"></th>
                </tr>
            </thead>
            <tbody id="portfolioBody"></tbody>
        </table>
    </div>

    <div class="summary-grid">
        <div class="card"><span>Total Invested</span><strong id="totalInvested">$0.00</strong></div>
        <div class="card"><span>Total Value</span><strong id="totalValue">$0.00</strong></div>
        <div class="card"><span>Total PnL</span><strong id="totalPnL">$0.00</strong></div>
    </div>

    <footer>
        Data provided by CoinGecko API. Follow updates at 
        <a href="https://www.youtube.com/@crypto_globalnews" target="_blank">@crypto_globalnews</a>
    </footer>
</div>

<script>
    let portfolio = JSON.parse(localStorage.getItem('crypto_pro_v4')) || [];
    let sortDir = {};

    function save() { localStorage.setItem('crypto_pro_v4', JSON.stringify(portfolio)); }

    // Add new trade
    function addTrade() {
        const id = document.getElementById('coinId').value.toLowerCase().trim();
        const date = document.getElementById('tradeDate').value || new Date().toISOString().split('T')[0];
        const amount = parseFloat(document.getElementById('holdings').value);
        const buyPrice = parseFloat(document.getElementById('buyPrice').value);

        if (!id || isNaN(amount) || isNaN(buyPrice)) return alert("Please enter valid data");
        
        portfolio.push({ id, date, amount, buyPrice, currentPrice: 0 });
        save();
        
        // Reset fields
        document.getElementById('coinId').value = '';
        document.getElementById('holdings').value = '';
        document.getElementById('buyPrice').value = '';
        
        fetchPrices();
    }

    // Live Search
    function filterTable() {
        const query = document.getElementById('searchInput').value.toLowerCase();
        const rows = document.querySelectorAll('#portfolioBody tr');
        rows.forEach(row => {
            row.style.display = row.innerText.toLowerCase().includes(query) ? '' : 'none';
        });
    }

    // One-Click Sorting
    function sortTable(n) {
        sortDir[n] = !sortDir[n];
        const keys = ['id', 'currentPrice', 'date', 'amount', 'buyPrice', 'invested', 'currentValue', 'pnl'];
        
        portfolio.sort((a, b) => {
            let v1 = a[keys[n]];
            let v2 = b[keys[n]];

            // Custom handle for calculated columns
            if(n === 5) { v1 = a.amount * a.buyPrice; v2 = b.amount * b.buyPrice; }
            if(n === 6) { v1 = a.amount * a.currentPrice; v2 = b.amount * b.currentPrice; }
            if(n === 7) { v1 = (a.amount * a.currentPrice) - (a.amount * a.buyPrice); v2 = (b.amount * b.currentPrice) - (b.amount * b.buyPrice); }

            if (typeof v1 === 'string') return sortDir[n] ? v1.localeCompare(v2) : v2.localeCompare(v1);
            return sortDir[n] ? v1 - v2 : v2 - v1;
        });
        render();
    }

    // Fetch live data
    async function fetchPrices() {
        const ids = [...new Set(portfolio.map(t => t.id))].join(',');
        if (!ids) { render(); return; }

        try {
            const response = await fetch(`https://api.coingecko.com/api/v3/simple/price?ids=${ids}&vs_currencies=usd`);
            const data = await response.json();
            
            portfolio.forEach(t => {
                if (data[t.id]) t.currentPrice = data[t.id].usd;
            });
            
            document.getElementById('lastUpdated').innerText = `Last update: ${new Date().toLocaleTimeString()}`;
            render();
        } catch (e) {
            document.getElementById('lastUpdated').innerText = "Update failed (Check Coin IDs)";
        }
    }

    function render() {
        const tbody = document.getElementById('portfolioBody');
        tbody.innerHTML = '';
        let totalInv = 0, totalVal = 0;

        portfolio.forEach((t, i) => {
            const invested = t.amount * t.buyPrice;
            const value = t.amount * (t.currentPrice || 0);
            const pnl = value - invested;
            
            totalInv += invested;
            totalVal += value;

            tbody.innerHTML += `
                <tr>
                    <td class="asset-name">${t.id}</td>
                    <td>$${(t.currentPrice || 0).toLocaleString(undefined, {minimumFractionDigits: 2})}</td>
                    <td>${t.date}</td>
                    <td>${t.amount.toLocaleString()}</td>
                    <td>$${t.buyPrice.toLocaleString()}</td>
                    <td>$${invested.toLocaleString(undefined, {minimumFractionDigits: 2})}</td>
                    <td>$${value.toLocaleString(undefined, {minimumFractionDigits: 2})}</td>
                    <td class="${pnl >= 0 ? 'profit' : 'loss'}">
                        ${pnl >= 0 ? '+' : ''}$${pnl.toLocaleString(undefined, {minimumFractionDigits: 2})}
                    </td>
                    <td><button class="btn-delete" onclick="portfolio.splice(${i},1); save(); render();">Ã—</button></td>
                </tr>`;
        });

        document.getElementById('totalInvested').innerText = `$${totalInv.toLocaleString(undefined, {minimumFractionDigits: 2})}`;
        document.getElementById('totalValue').innerText = `$${totalVal.toLocaleString(undefined, {minimumFractionDigits: 2})}`;
        const totalPnL = totalVal - totalInv;
        document.getElementById('totalPnL').innerText = `${totalPnL >= 0 ? '+' : ''}$${totalPnL.toLocaleString(undefined, {minimumFractionDigits: 2})}`;
        document.getElementById('totalPnL').className = totalPnL >= 0 ? 'profit' : 'loss';
    }

    // Auto-Refresh every 60 seconds
    setInterval(fetchPrices, 60000);

    // Initial Load
    render();
    if(portfolio.length) fetchPrices();
</script>

</body>
</html>
